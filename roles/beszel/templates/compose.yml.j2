services:
  beszel:
    image: henrygd/beszel:0.18.4@sha256:64bcaa60d1ed4149f0628c70cf68044b5d1ea90b3437de41e009e873f50e3f36
    container_name: "{{ services.beszel.container_name }}"
    restart: always
    networks:
      - default
      - caddy
    volumes:
      - "{{ beszel_data_dir }}/data:/beszel_data"
      - "{{ beszel_data_dir }}/socket:/beszel_socket"
    environment:
      APP_URL: "https://{{ services.beszel.domain }}"
      USER_EMAIL: "{{ beszel_email }}"
      USER_PASSWORD: "{{ beszel_password }}"
      DISABLE_PASSWORD_AUTH: {{ sso_enabled }}
    healthcheck:
      test: ['CMD', '/beszel', 'health', '--url', 'http://localhost:8090']
      start_period: 5s
      interval: 120s

  beszel-agent:
    image: henrygd/beszel-agent:0.18.4-alpine@sha256:f27e7b419b922cd09e14e7060972e71da0e7d17db4f93a4e1a37e37e4aa8ca6d
    container_name: beszel-agent
    restart: always
    network_mode: host
    volumes:
      - "{{ beszel_data_dir }}/agent:/var/lib/beszel-agent"
      - "{{ beszel_data_dir }}/socket:/beszel_socket"
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/run/dbus/system_bus_socket:/var/run/dbus/system_bus_socket:ro
      - "{{ data_base_dir }}/.beszel:/extra-filesystems/nvme0n1__Data:ro"
      - "{{ backup_base_dir }}/.beszel:/extra-filesystems/nvme1n1__Backup:ro"
    devices:
      - /dev/nvme0:/dev/nvme0
      - /dev/nvme1:/dev/nvme1
    cap_add:
      - SYS_RAWIO # required for S.M.A.R.T. data
      - SYS_ADMIN # required for NVMe S.M.A.R.T. data
    environment:
      LISTEN: "/beszel_socket/beszel.sock"
      HUB_URL: "https://{{ services.beszel.domain }}"
      TOKEN: "{{ beszel_agent_token }}"
      KEY: "{{ beszel_agent_key }}"
      SENSORS: "-nvme_sensor_*"
    healthcheck:
      test: ['CMD', '/agent', 'health']
      interval: 120s

networks:
  caddy:
    external: true
