---
- name: "Create backup directory for {{ service_name }}"
  ansible.builtin.file:
    path: "{{ backup_dir }}"
    state: directory
    mode: "0755"
  become: true

- name: "Run backup command for {{ service_name }}"
  community.docker.docker_compose_v2_exec:
    project_src: "{{ service_dir }}"
    service: "{{ run_service_name }}"
    command: "{{ run_command }}"
    env: "{{ run_command_env }}"
  register: command_result
  when: run_command != ""

- name: "Save data dump for {{ service_name }}"
  ansible.builtin.copy:
    content: "{{ command_result.stdout }}"
    dest: "{{ dump_path }}"
    mode: "0644"
  when: run_command_produces_stdout and command_result.stdout is defined and command_result.stdout | length > 0
  become: true

- name: "Compress data dump for {{ service_name }}"
  community.general.archive:
    path: "{{ dump_path }}"
    dest: "{{ dump_path }}.gz"
    format: gz
    remove: true
    mode: "0644"
  become: true
  when: run_command_produces_stdout and command_result.stdout is defined and command_result.stdout | length > 0

- name: "Copy data to backup directory for {{ service_name }}"
  ansible.builtin.copy:
    src: "{{ data_dir }}/{{ path }}"
    dest: "{{ backup_dir }}/{{ path }}"
    remote_src: true
    mode: "0755"
  loop: "{{ data_paths }}"
  loop_control:
    loop_var: path
  become: true
