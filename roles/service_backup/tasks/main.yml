- name: "Backup for {{ service_name }}"
  block:
    - name: Create temp backup directory
      ansible.builtin.file:
        path: "{{ temp_backup_dir }}"
        state: directory
        mode: "0755"
        owner: "{{ ansible_user_uid }}"
        group: "{{ ansible_user_gid }}"
      become: true

    - name: Service Operations
      block:
        - name: "Stop services for {{ service_name }}"
          community.docker.docker_compose_v2:
            project_src: "{{ service_dir }}"
            services: "{{ stop_services }}"
            state: stopped
          when: stop_services | length > 0

        - name: "Run backup command for {{ service_name }}"
          community.docker.docker_compose_v2_exec:
            project_src: "{{ service_dir }}"
            service: "{{ run_service_name }}"
            command: "{{ run_command }}"
            env: "{{ run_command_env }}"
          register: backup_output
          no_log: true # Prevent sensitive dump data from spamming logs
          when:
            - run_command != ""
            - run_command_produces_stdout | bool

        - name: "Save backup to file for {{ service_name }}"
          ansible.builtin.copy:
            content: "{{ backup_output.stdout }}"
            dest: "{{ dump_path }}"
            mode: "0644"
          when:
            - run_command != ""
            - run_command_produces_stdout | bool

      always:
        - name: "Start services for {{ service_name }}"
          community.docker.docker_compose_v2:
            project_src: "{{ service_dir }}"
            state: present
          when: stop_services | length > 0

    - name: Copy extra data files
      ansible.builtin.copy:
        src: "{{ data_dir }}/{{ item }}"
        dest: "{{ temp_backup_dir }}/{{ item }}"
        remote_src: true
        mode: "0755"
      loop: "{{ data_paths }}"
      become: true

    - name: Atomic Swap Operation
      block:
        - name: "Pre-cleanup old backup rotation"
          ansible.builtin.file:
            path: "{{ backup_dir }}_old"
            state: absent
          become: true
        - name: "Rotate current backup to old"
          ansible.builtin.command:
            cmd: "mv {{ backup_dir }} {{ backup_dir }}_old"
            removes: "{{ backup_dir }}"
          become: true
        - name: "Promote temp backup to final location"
          ansible.builtin.command:
            cmd: "mv {{ temp_backup_dir }} {{ backup_dir }}"
            creates: "{{ backup_dir }}"
            removes: "{{ temp_backup_dir }}"
          become: true
        - name: "Remove old backup directory"
          ansible.builtin.file:
            path: "{{ backup_dir }}_old"
            state: absent
          become: true
      rescue:
        - name: "Restore old backup to live"
          ansible.builtin.command:
            cmd: "mv {{ backup_dir }}_old {{ backup_dir }}"
            creates: "{{ backup_dir }}"
            removes: "{{ backup_dir }}_old"
          become: true
          failed_when: false
        - name: "WARNING: Backup Failed for {{ service_name }}"
          ansible.builtin.debug:
            msg:
              - "CRITICAL WARNING: The backup for {{ service_name }} failed during rotation."
              - "The system attempted to roll back to the previous backup."
              - "Please check the logs. Proceeding with other backups..."

  always:
    - name: "Cleanup temp directory"
      ansible.builtin.file:
        path: "{{ temp_backup_dir }}"
        state: absent
      become: true
