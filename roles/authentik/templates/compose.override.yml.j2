services:
  postgresql:
    image: postgres:18-alpine@sha256:f898ac406e1a9e05115cc2efcb3c3abb3a92a4c0263f3b6f6aaae354cbb1953a
    container_name: "authentik-postgres"
    restart: always
    volumes:
      - "{{ authentik_data_dir }}/db:/var/lib/postgresql/data"
  redis:
    image: redis:alpine
    container_name: "authentik-redis"
    restart: always
    volumes:
      - "{{ authentik_data_dir }}/redis:/data"
  server:
    image: authentik/server:2025.8.4
    container_name: "{{ services.authentik.container_name }}"
    restart: always
    networks:
      - default
      - caddy
    ports: !reset null
    volumes:
      - "{{ authentik_data_dir }}/media:/media"
      - "{{ authentik_data_dir }}/templates:/templates"
  worker:
    image: authentik/server:2025.8.4
    container_name: "authentik-worker"
    restart: always
    volumes:
      - "{{ authentik_data_dir }}/media:/media"
      - "{{ authentik_data_dir }}/certs:/certs"
      - "{{ authentik_data_dir }}/templates:/templates"

networks:
  caddy:
    external: true
