# external-file
# owner: FuzzyGrim
# repo: Yamtrack
# path: docker-compose.yml
# commit-hash: 4a5abba1f211883fa1c76865838ff218f3ebbd83

services:
  yamtrack:
    image: ghcr.io/fuzzygrim/yamtrack:0.24.11@sha256:1e6ff393d1a1e4463d9e35227acae29da31a0a6119719c1054e67c5fec22618b
    container_name: "{{ services.yamtrack.container_name }}"
    restart: always
    environment:
      TZ: "{{ timezone }}"
      SECRET: "{{ yamtrack_secret_key }}"
      URLS: "https://{{ services.yamtrack.domain }}"
      REGISTRATION: "{{ yamtrack_enable_registration }}"
      TMDB_NSFW: "True"
      SOCIAL_PROVIDERS: "allauth.socialaccount.providers.openid_connect"
      SOCIALACCOUNT_PROVIDERS: '{"openid_connect":{"OAUTH_PKCE_ENABLED":true,"APPS":[{"provider_id":"pocketid","name":"Pocket ID","client_id":"{{ yamtrack_oidc_client_id }}","secret":"{{ yamtrack_oidc_secret }}","settings":{"server_url":"https://{{ services.pocket_id.domain }}/.well-known/openid-configuration"}}]}}'
      SOCIALACCOUNT_ONLY: "{{ sso_enabled }}"
      REDIRECT_LOGIN_TO_SSO: "{{ sso_enabled }}"
    networks:
      - default
      - caddy
    volumes:
      - "{{ yamtrack_data_dir }}/db:/yamtrack/db"
    ports: !reset []

  redis:
    image: redis:8-alpine@sha256:6cbef353e480a8a6e7f10ec545f13d7d3fa85a212cdcc5ffaf5a1c818b9d3798
    restart: always
    volumes:
      - "{{ yamtrack_data_dir }}/redis:/data"

networks:
  caddy:
    external: true
