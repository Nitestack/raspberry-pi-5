# external-file: https://raw.githubusercontent.com/ente-io/ente/main/server/quickstart.sh
# digest: c59c0c91667ac227e4b2cbc9aa2ae155677a6b4bd64d0c5846801ac0fa09a3b3

services:
  museum:
    image: ghcr.io/ente-io/server:latest@sha256:3c922f9f6dca7b6510449b9eb2d2fb012e4749df25e005db96a92f70626af626
    container_name: "{{ services.ente_api.container_name }}"
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - default
      - caddy
    volumes:
      - "{{ ente_auth_service_dir }}/museum.yml:/museum.yaml:ro"
      - "{{ ente_auth_data_dir }}/data:/data:ro"
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:8080/ping"]
      interval: 60s
      timeout: 5s
      retries: 3
      start_period: 5s

  web:
    image: ghcr.io/ente-io/web:latest@sha256:c1c12c861fc46584e7ae3f34094c30b6e70e5d4175b64d295f9de1f659c5fab7
    container_name: "{{ services.ente_auth.container_name }}"
    restart: always
    networks:
      - default
      - caddy
    environment:
      ENTE_API_ORIGIN: "https://{{ services.ente_api.domain }}"

  postgres:
    image: postgres:15@sha256:08155957f670000953ad9bf7f654a13bb0d4fb01b8f1cc83736f2fd18601aab4
    container_name: ente-postgres
    restart: always
    environment:
      POSTGRES_USER: "{{ ente_db_user }}"
      POSTGRES_PASSWORD: "{{ ente_db_password }}"
      POSTGRES_DB: "{{ ente_db_name }}"
    healthcheck:
      test: pg_isready -q -d {{ ente_db_name }} -U {{ ente_db_user }}
      start_period: 40s
      start_interval: 1s
    volumes:
      - "{{ ente_auth_data_dir }}/db:/var/lib/postgresql/data"

networks:
  caddy:
    external: true
