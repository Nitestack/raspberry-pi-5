name: Deployment

on:
  push:
    branches:
      - master

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
      - id: changed-files
        uses: tj-actions/changed-files@24d32ffd492484c1d75e0c0b894501ddb9d30d62 # v47
      - id: set-tags
        run: |
          tags_list=()
          run_all=false
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            if [[ "$file" == "deploy.yml" || "$file" == group_vars/* ]]; then
              run_all=true
              break
            elif [[ "$file" == roles/* ]]; then
              role=$(echo "$file" | cut -d'/' -f2)
              if ! [[ " ${tags_list[*]} " =~ " ${role} " ]]; then
                tags_list+=("$role")
              fi
            fi
          done

          if [[ "$run_all" == true ]]; then
            echo "ansible_tags=all" >> $GITHUB_OUTPUT
          elif [[ ${#tags_list[@]} -gt 0 ]]; then
            tags=$(IFS=,; echo "${tags_list[*]}")
            echo "ansible_tags=$tags" >> $GITHUB_OUTPUT
          else
            echo "ansible_tags=none" >> $GITHUB_OUTPUT
          fi
      - if: steps.set-tags.outputs.ansible_tags != 'none'
        run: echo ${{ secrets.ANSIBLE_VAULT_PASSWORD }} > .vault_pass
      - if: steps.set-tags.outputs.ansible_tags != 'none'
        uses: ansible/ansible-lint@main
        with:
          requirements_file: requirements.yml
      - if: steps.set-tags.outputs.ansible_tags != 'none'
        uses: dawidd6/action-ansible-playbook@93764e7048f4dd16117d134dadb4b36e8ee73227 # v4
        with:
          playbook: deploy.yml
          requirements: requirements.yml
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          inventory: |
            [raspberrypi]
            npham.de ansible_user=nhan ansible_python_interpreter=auto_silent
          vault_password: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}
          options: |
            --tags ${{ steps.set-tags.outputs.ansible_tags }}
